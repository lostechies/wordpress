---
id: 214
title: 'Cool stuff in FubuMVC No. 1: Behaviors'
date: 2011-06-23T18:30:00+00:00
author: Chad Myers
layout: post
guid: http://lostechies.com/chadmyers/?p=214
permalink: /2011/06/23/cool-stuff-in-fubumvc-no-1-behaviors/
dsq_thread_id:
  - "340711701"
categories:
  - .NET
  - cool-stuff-in-fubu
  - FubuMVC
---
This is the first post of the FubuMVC series mentioned in the [Introduction post](http://lostechies.com/chadmyers/2011/05/30/cool-stuff-in-fubucore-and-fubumvc-series/).

Perhaps the coolest thing about FubuMVC (and I’m not kidding when I say there’s a lot of cool stuff) is the behavior model. This fundamental concept enables almost all of the other coolness in FubuMVC.&nbsp; The concept is this: There is no controller. I’m not trying to be [cute or clever](http://www.youtube.com/watch?v=dzm8kTIj_0M), I mean it.&nbsp; When you look at some of the other MVC frameworks out there, they have a fairly strong notion of “Controller class” baked into the framework. So much so that they require a [base](http://msdn.microsoft.com/en-us/library/system.web.mvc.controllerbase.aspx) [class](http://struts.apache.org/2.0.6/struts2-core/apidocs/com/opensymphony/xwork2/ActionSupport.html)&nbsp;[for](http://static.springsource.org/spring/docs/2.5.x/api/org/springframework/web/servlet/mvc/AbstractController.html) [you](https://docs.djangoproject.com/en/dev/ref/class-based-views/#django.views.generic.base.TemplateView)(*) [to](http://www.castleproject.org/monorail/gettingstarted/smartdispatcher.html) [derive from](http://api.rubyonrails.org/classes/ActionController/Base.html). [(*) Django doesn’t require to you subclass a controller (what they call a ‘view’, confusingly) but it enables some scenarios you can’t get unless you subclass].&nbsp;&nbsp; Main problem #1: The framework is far too invasive into my code. Stated differently: I shouldn’t have to derive from anything or import/”using” any of your code to do simple-to-medium complexity things with your framework.&nbsp; And if, in an average controller class “.cs” file, I need to have more “using” statements for your framework than I need for my app code, we have major problems.

To be specific, most of these frameworks are of the “[Model 2](http://en.wikipedia.org/wiki/Model_2)” variety of MVC.&nbsp; It turns out that these frameworks, by nature of their fundamental design, encourage fat controllers (except, perhaps, Django, but I don’t know it well enough to speak definitively).&nbsp; Each has a way (some better, some worse) to get some of the logic out of the controller and move it somewhere else.&nbsp; But in using them, you definitely get the sense that things would be a lot easier to toss into the controller action itself and be done.&nbsp; The framework doesn’t “encourage” you to spread out responsibilities.&nbsp; A typical controller might have the following responsibilities:

  * Authenticate the user
  * Authorize the request
  * Bind the request to one or more model or models
  * Validate those models
  * ! Perform the primary logic of the action !
  * Respond to failure if the primary logic failed for some reason (threw an error, returned negatively, etc)
  * Determine what result to send to the client (render a view, JSON, HTTP redirect, etc)
  * Prepare the output model/json/redirect URL in order for the result to proceed
  * Transfer control to the result (with an explicit call in many cases)

Most everyone realizes that this list is far too long for the average controller action to handle. Your method will be very long, have lots of branching, and be nearly impossible to unit test effectively.&nbsp; You will also be repeating a lot of code (violating the [DRY principle](http://en.wikipedia.org/wiki/Don't_repeat_yourself)). Problem #2: Many MVC frameworks encourage “fat” controllers.

In ASP.NET MVC, you’d move many of the earlier things to ActionFilters that run before and some of the later things into ActionResults.&nbsp; The other frameworks have similar ways of adding pre- and post-logic to an action which helps with [SRP](http://lostechies.com/seanchambers/2008/03/15/ptom-single-responsibility-principle/) and DRY.&nbsp; While these help, the level of granularity and control over the web request pipeline generally isn’t enough to allow better separation and composition of responsibilities.&nbsp; Problem #3: Not enough granularity and/or compose-ability (usually, it’s an after-thought).

Seeing these problems and many others, we realized that we needed to change a few things about how we approached our web framework.&nbsp; We needed to have a framework that encouraged skinny controllers.&nbsp;&nbsp; When you get down to it, the only thing the controller should be doing is the “! Perform the primary logic of the action !”.&nbsp; We found that when we had multiple actions in a controller, that, while each action was skinny, the controller was still pretty fat.&nbsp;&nbsp; This let us eventually to determine: There should be no controller at all! All that matters is the action. Since, in C#, you can’t have a method without a class around it, we still needed a class to wrap around the action method, but that’s _it_. This class’s sole purpose is to provide a container for the action method. It can have fields, private methods, etc. that all support that one action method, but it should only have one action method.&nbsp; You can call this class a “controller” if you like, but it has very little in common with the Model 2 frameworks’ “controller” classes.

## “Behaviors”

The solution we came up with involved a pipeline of small, compose-able units of functionality. Each should have its own small responsibility. Each should have the ability be able to wrap the entire pipeline to execute before, after, or around the action.&nbsp; When we first built FubuMVC, we called these “decorators” because they were originally designed a lot like the decorator pattern, but not exactly. They also behaved somewhat like a chain-of-responsibility pattern, but not exactly. They also behaved somewhat like “commands” in the [Front Controller pattern](http://martinfowler.com/eaaCatalog/frontController.html), but not exactly.&nbsp; We struggled with the nomenclature and a word that captured the unique essence of what these things did. Hat tip to [Steven Harman](http://stevenharman.net/), he coined the term “Behavior,” and it stuck.&nbsp; More than just ActionFilters and ActionResults, behaviors can hook into and override any part of the pipeline allowing for many interesting&nbsp; scenarios and maximum flexibility when building complex, compositional applications (which is what we were and are still trying to do at [Dovetail Software](http://www.dovetailsoftware.com/) – we’re [hiring](http://www.dovetailsoftware.com/senior-net-technical-lead), [by](http://www.dovetailsoftware.com/.NET%20Developers) the [way](http://www.dovetailsoftware.com/front-end-developer)).

The way behaviors work is simple. They have a very [simple interface](https://github.com/DarthFubuMVC/fubumvc/blob/master/src/FubuMVC.Core/Behaviors/IActionBehavior.cs) (basically one method: Invoke() and a method InvokePartial in case the behavior needs to behave differently when being invoked in a partial).&nbsp; Since everything in FubuMVC [runs through IoC](https://twitter.com/#!/hcoverlambda/status/83916665041072128) and is fully compositional in design (versus inheritance-based as in the other frameworks), a behavior takes in the next behavior in the chain and can execute it or not.&nbsp; By not executing it, the behavior takes on the responsibility for completing the entire request. An example of this would be an authorization behavior that needs to usurp the pipeline because a user doesn’t have the correct permissions to view this page.&nbsp; The behavior will then send the request down another pipeline that results in an “HTTP 403 Access Denied” view being rendered.&nbsp; For your _convenience_ (and only for _convenience_, it’s not required), there is an [abstract base class](https://github.com/DarthFubuMVC/fubumvc/blob/master/src/FubuMVC.Core/Behaviors/BasicBehavior.cs) you _can_ derive from which does some of the boring basic behavior stuff.

To learn more technical details and how-to about behaviors, you should probably read the [FubuMVC Guide](http://guides.fubumvc.com/advanced_behaviors.html) on the subject (yes, [these guides](https://github.com/DarthFubuMVC/fubumvc-guides) look like [Rails guides](https://github.com/lifo/docrails) because they are a fork from [Spree guides](https://github.com/spree/spree-guides)).

## Conventions, the real pay-off

Up until now, you may think something along the lines of: “Meh, behaviors are cool, but they’re really just glorified before/after filters/results and don’t really change \*that\* much of the game.”&nbsp; Of course you’d be wrong, but not unreasonable – until you consider the conventional application of those behaviors to actions.

As the sub-title suggests, conventionally applying behaviors to actions is where things get really interesting and when most people have the big “Ah-hah!” moment.&nbsp; Again, I encourage you to read the “_[Advanced Behaviors](http://guides.fubumvc.com/advanced_behaviors.html)_” guide as it goes into a lot of the specifics.&nbsp; This post will just be an overview and conceptual treatment of the subject.

Every app has its own conventions whether you call them that or not. When I say “conventions” I mean anything that, when a new developer joins your team, you explain to him/[her](http://www.techrepublic.com/blog/programming-and-development/it-gender-gap-where-are-the-female-programmers/2386) that “this is the way we do things.”&nbsp; For example, any method in any class in this namespace is “secure” or any method with the “[Secure]” attribute, and any method whose name ends in “Secure” are examples of conventions.&nbsp; FubuMVC allows you to define those conventions in code, make them first-class citizens in your app, and use them to apply behavior(s) to your actions.&nbsp; The best part is, you don’t have to use any of the framework’s attributes or interfaces or base classes. You can do it by names of types or methods, or by your own custom attributes or interfaces.&nbsp; This helps lessen the number of “using” statements required to use the framework. Our goal is to have zero-to-a-few “using” statements in your app code.&nbsp; When we talk about more or less “[intrusive](http://codebetter.com/jeremymiller/2008/05/19/what-dan-simmons-forgot-to-tell-you-about-the-entity-framework/)” or “[unobstrusive](https://github.com/DarthFubuMVC/fubumvc/blob/master/src/FubuMVC.HelloWorld/Controllers/LimitMethods/LimitMethodsController.cs)” (look Ma, no using statements! Pure POCO!), this is what we mean.

In fact, almost everything in FubuMVC is based on your conventions. The idea is FubuMVC brings the bag of tools and you tell it where and how you want things wired up.

## Summary

I realize this post was light on code and some specifics. This was intentional. I wanted this to be more a philosophical post about our approach. It is important for you to understand this as the rest of the posts in this series will make increasingly more sense as you begin to understand this and think like we do when it comes to approaching framework building (especially web framework building).&nbsp; If you really want specifics and haven’t checked out the “[_Advanced Behaviors_](http://guides.fubumvc.com/advanced_behaviors.html)” guide, I invite you one last time.&nbsp;&nbsp; As this series progresses, I’ll get into more specifics of just how deep the configurability and conventional approach runs in FubuMVC and a lot of this post will begin to make more sense.